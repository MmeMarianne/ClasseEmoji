<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClasseEmoji - Groupe 401</title>
    
    <!-- Intégration de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #4e73df;
            --success: #1cc88a;
            --danger: #e74a3b;
            --warning: #f6c23e;
            --light: #f8f9fc;
            --dark: #5a5c69;
            --selected: #e8f4ff;
            --absent: #f8d7da;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fb;
            color: var(--dark);
            padding: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            text-align: center;
            position: relative;
        }
        
        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            font-size: 0.8rem;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-connected {
            background-color: var(--success);
        }
        
        .status-disconnected {
            background-color: var(--danger);
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 1.4rem;
        }
        
        /* Navigation par onglets */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            padding: 12px 15px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .tab.active {
            background-color: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Contrôles */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .selection-controls, .global-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .select-all-btn {
            background-color: var(--primary);
            color: white;
        }
        
        .deselect-all-btn {
            background-color: #6c757d;
            color: white;
        }
        
        .add-points-btn {
            background-color: var(--success);
            color: white;
        }
        
        .remove-points-btn {
            background-color: var(--danger);
            color: white;
        }
        
        .reset-btn {
            background-color: var(--warning);
            color: white;
        }
        
        .change-avatar-btn {
            background-color: #6f42c1;
            color: white;
        }
        
        .mark-absent-btn {
            background-color: #fd7e14;
            color: white;
        }
        
        .mark-present-btn {
            background-color: #20c997;
            color: white;
        }
        
        .save-btn {
            background-color: var(--success);
            color: white;
        }
        
        /* Grille d'élèves */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
        }
        
        .student-card {
            background-color: white;
            border-radius: 8px;
            padding: 10px 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s;
            position: relative;
            height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
        }
        
        .student-card.absent {
            background-color: var(--absent);
            opacity: 0.8;
        }
        
        .student-card.selected {
            background-color: var(--selected);
            border: 2px solid var(--primary);
        }
        
        .student-checkbox {
            position: absolute;
            top: 6px;
            left: 6px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            z-index: 2;
        }
        
        .student-avatar {
            margin: 2px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 60px;
        }
        
        .avatar-img {
            font-size: 3.5rem;
            line-height: 1;
        }
        
        .student-name {
            font-size: 0.85rem;
            margin-bottom: 3px;
            font-weight: 500;
            line-height: 1.2;
            max-height: 2.4em;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .student-id {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 3px;
        }
        
        .points {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 3px 0;
        }
        
        .positive {
            color: var(--success);
        }
        
        .negative {
            color: var(--danger);
        }
        
        .absent-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .summary {
            margin-top: 15px;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .summary h3 {
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        /* Formulaire de gestion des élèves */
        .student-form {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .student-list {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .student-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        
        .student-item:last-child {
            border-bottom: none;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 10px;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal h2 {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 1.3rem;
        }
        
        .modal p {
            margin-bottom: 20px;
            font-size: 1rem;
        }
        
        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
        }
        
        .confirm-btn {
            background-color: var(--danger);
            color: white;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .cancel-btn {
            background-color: #6c757d;
            color: white;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        /* Popup de points */
        .points-popup {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .points-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .point-btn {
            padding: 12px;
            font-size: 1.1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .positive-btn {
            background-color: var(--success);
            color: white;
        }
        
        .negative-btn {
            background-color: var(--danger);
            color: white;
        }
        
        /* Grille d'avatars */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .avatar-option {
            width: 70px;
            height: 70px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            background-color: #f8f9fc;
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
            background-color: #e9ecef;
        }
        
        .avatar-option.selected {
            background-color: var(--selected);
            transform: scale(1.1);
            border: 2px solid var(--primary);
        }
        
        .avatar-option-emoji {
            font-size: 2.8rem;
        }
        
        @media (min-width: 768px) {
            body {
                padding: 15px;
            }
            
            header {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            h1 {
                font-size: 1.6rem;
                margin-bottom: 10px;
            }
            
            .tabs {
                margin-bottom: 20px;
            }
            
            .tab {
                padding: 15px 20px;
                font-size: 1rem;
            }
            
            .controls {
                flex-direction: row;
                justify-content: space-between;
                padding: 15px;
                margin-bottom: 20px;
            }
            
            button {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .student-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
                gap: 15px;
            }
            
            .student-card {
                padding: 12px 10px;
                height: 170px;
            }
            
            .avatar-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 12px;
            }
        }
        
        @media (min-width: 1024px) {
            .student-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .avatar-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="connection-status" id="connectionStatus">
                <div class="status-dot status-disconnected"></div>
                <span>Déconnecté</span>
            </div>
            <h1>ClasseEmoji - Groupe 401</h1>
            <p>Compilation des points verts et rouges pour vos élèves</p>
        </header>
        
        <!-- Navigation par onglets -->
        <div class="tabs">
            <div class="tab active" data-tab="student-view">Vue Élèves</div>
            <div class="tab" data-tab="teacher-view">Vue Enseignant</div>
        </div>
        
        <!-- Vue Élèves -->
        <div class="tab-content active" id="student-view">
            <div class="controls">
                <div class="selection-controls">
                    <button class="select-all-btn" id="selectAllBtn">Sélectionner tous</button>
                    <button class="deselect-all-btn" id="deselectAllBtn">Désélectionner tous</button>
                </div>
                <div class="global-actions">
                    <button class="add-points-btn" id="addPointsBtn">+ Points</button>
                    <button class="remove-points-btn" id="removePointsBtn">- Points</button>
                    <button class="mark-absent-btn" id="markAbsentBtn">Marquer absent</button>
                    <button class="mark-present-btn" id="markPresentBtn">Marquer présent</button>
                    <button class="reset-btn" id="resetBtn">Reset points</button>
                    <button class="change-avatar-btn" id="changeAvatarBtn">Avatar</button>
                </div>
            </div>
            
            <div class="student-grid" id="studentGrid">
                <!-- Les cartes des élèves seront générées ici -->
            </div>
            
            <div class="summary">
                <h3>Résumé de la classe</h3>
                <p>Total des points verts: <span id="totalGreen">0</span> | Total des points rouges: <span id="totalRed">0</span> | Élèves absents: <span id="totalAbsent">0</span></p>
            </div>
        </div>
        
        <!-- Vue Enseignant -->
        <div class="tab-content" id="teacher-view">
            <div class="student-form">
                <h2>Gérer les élèves</h2>
                <div class="form-group">
                    <label for="studentId">Numéro de classe</label>
                    <input type="number" id="studentId" min="1" max="99" placeholder="Numéro">
                </div>
                <div class="form-group">
                    <label for="studentName">Prénom de l'élève</label>
                    <input type="text" id="studentName" placeholder="Prénom">
                </div>
                <button class="save-btn" id="addStudentBtn">Ajouter l'élève</button>
            </div>
            
            <div class="student-list" id="studentList">
                <h2>Liste des élèves</h2>
                <!-- La liste des élèves sera générée ici -->
            </div>
        </div>
    </div>

    <!-- Modal de confirmation pour la réinitialisation -->
    <div class="modal" id="resetModal">
        <div class="modal-content">
            <h2>Confirmation de réinitialisation</h2>
            <p>Êtes-vous sûr de vouloir réinitialiser tous les points à zéro ?</p>
            <p>Cette action est irréversible.</p>
            <div class="modal-actions">
                <button class="cancel-btn" id="cancelReset">Annuler</button>
                <button class="confirm-btn" id="confirmReset">Tout réinitialiser</button>
            </div>
        </div>
    </div>

    <!-- Modal de sélection d'avatar -->
    <div class="modal" id="avatarModal">
        <div class="modal-content">
            <h2>Choisir un avatar</h2>
            <p>Sélectionnez un élève puis choisissez un avatar parmi les options ci-dessous</p>
            
            <div class="avatar-grid" id="avatarGrid">
                <!-- Les options d'avatar seront générées ici -->
            </div>
            
            <div class="modal-actions">
                <button class="cancel-btn" id="cancelAvatar">Annuler</button>
                <button class="confirm-btn" id="confirmAvatar">Appliquer l'avatar</button>
            </div>
        </div>
    </div>

    <!-- Popup pour AJOUTER des points -->
    <div class="modal" id="addPointsModal">
        <div class="modal-content">
            <h2>Ajouter des points</h2>
            <p id="addPointsModalText">Sélectionnez le nombre de points à ajouter</p>
            
            <div class="points-popup">
                <div class="points-buttons">
                    <button class="point-btn positive-btn" data-points="1">+1</button>
                    <button class="point-btn positive-btn" data-points="2">+2</button>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="cancel-btn" id="cancelAddPoints">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Popup pour RETIRER des points -->
    <div class="modal" id="removePointsModal">
        <div class="modal-content">
            <h2>Retirer des points</h2>
            <p id="removePointsModalText">Sélectionnez le nombre de points à retirer</p>
            
            <div class="points-popup">
                <div class="points-buttons">
                    <button class="point-btn negative-btn" data-points="-1">-1</button>
                    <button class="point-btn negative-btn" data-points="-2">-2</button>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="cancel-btn" id="cancelRemovePoints">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION FIREBASE ====================
        // Configuration Firebase pour le projet ClasseEmoji
        const firebaseConfig = {
            apiKey: "AIzaSyBBCRNQAlf3rJBtXufQOhUk-ErLoPx4mcA",
            authDomain: "classeemoji-520a1.firebaseapp.com",
            databaseURL: "https://classeemoji-520a1-default-rtdb.firebaseio.com",
            projectId: "classeemoji-520a1",
            storageBucket: "classeemoji-520a1.firebasestorage.app",
            messagingSenderId: "258178839258",
            appId: "1:258178839258:web:a8007058aafbe2462babe3"
        };
        
        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Référence à la collection des élèves
        const studentsRef = db.collection("students");
        
        // ==================== SYSTÈME DE SONS ====================
        
        // Créer l'audio context pour générer les sons
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Fonction pour jouer un son positif (point vert)
        function playPositiveSound() {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // Do (C5)
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // Mi (E5)
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // Sol (G5)
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log("Son positif non disponible");
            }
        }
        
        // Fonction pour jouer un son négatif (point rouge)
        function playNegativeSound() {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(220, audioContext.currentTime); // La (A3)
                oscillator.frequency.setValueAtTime(196, audioContext.currentTime + 0.2); // Sol (G3)
                oscillator.frequency.setValueAtTime(174.61, audioContext.currentTime + 0.4); // Fa (F3)
                
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.6);
            } catch (error) {
                console.log("Son négatif non disponible");
            }
        }
        
        // ==================== GESTION DE LA CONNEXION ====================
        const connectionStatus = document.getElementById('connectionStatus');
        const statusDot = connectionStatus.querySelector('.status-dot');
        const statusText = connectionStatus.querySelector('span');
        
        // Surveiller l'état de connexion
        firebase.firestore().enableNetwork()
            .then(() => {
                statusDot.classList.remove('status-disconnected');
                statusDot.classList.add('status-connected');
                statusText.textContent = 'Connecté';
            })
            .catch((error) => {
                console.error("Erreur de connexion: ", error);
                statusDot.classList.remove('status-connected');
                statusDot.classList.add('status-disconnected');
                statusText.textContent = 'Déconnecté';
            });
        
        // Écouter les changements de connexion
        firebase.firestore().onSnapshotsInSync(() => {
            statusDot.classList.remove('status-disconnected');
            statusDot.classList.add('status-connected');
            statusText.textContent = 'Connecté';
        });
        
        // ==================== DONNÉES PAR DÉFAUT ====================
        // Liste de 100 avatars pour enfants de 10 ans
        const avatars = [
            "🐶", "🐱", "🐭", "🐹", "🐰", "🦊", "🐻", "🐼", "🐨", "🐯",
            "🦁", "🐮", "🐷", "🐸", "🐙", "🐵", "🦄", "🐢", "🐬", "🐳",
            "🦖", "🐠", "🐌", "🦉", "🐧", "🦜", "🐘", "🦒", "🦏", "🐪",
            "🦩", "🦘", "🐿️", "🦔", "🦇", "🦥", "🦦", "🦨", "🦚", "🦃",
            "🐲", "🌞", "⭐", "🌈", "🌺", "🍕", "🍦", "🚀", "🎮", "🎸",
            // Nouveaux avatars
            "🤖", "👾", "🦕", "🦴", "🐾", "🌻", "🍄", "🌍", "🌕", "🪐",
            "🔥", "💧", "🌪️", "❄️", "⚡", "💫", "🧩", "🎯", "🎨", "🎪",
            "🎭", "🛸", "🧸", "🎁", "🎊", "🎉", "🪁", "🧭", "🔭", "💎",
            "🧠", "👁️", "👅", "👂", "👃", "👣", "👄", "🦷", "🦴", "💪",
            "🧚", "🧜", "🧞", "🧝", "🦸", "🦹", "🧙", "🧛", "🧟", "🎅"
        ];
        
        // Données des élèves (vide au début, sera chargé depuis Firebase)
        let students = [];
        
        // ==================== ÉLÉMENTS DOM ====================
        const studentGrid = document.getElementById('studentGrid');
        const studentList = document.getElementById('studentList');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const addPointsBtn = document.getElementById('addPointsBtn');
        const removePointsBtn = document.getElementById('removePointsBtn');
        const markAbsentBtn = document.getElementById('markAbsentBtn');
        const markPresentBtn = document.getElementById('markPresentBtn');
        const resetBtn = document.getElementById('resetBtn');
        const changeAvatarBtn = document.getElementById('changeAvatarBtn');
        const totalGreenSpan = document.getElementById('totalGreen');
        const totalRedSpan = document.getElementById('totalRed');
        const totalAbsentSpan = document.getElementById('totalAbsent');
        const resetModal = document.getElementById('resetModal');
        const cancelReset = document.getElementById('cancelReset');
        const confirmReset = document.getElementById('confirmReset');
        const avatarModal = document.getElementById('avatarModal');
        const avatarGrid = document.getElementById('avatarGrid');
        const cancelAvatar = document.getElementById('cancelAvatar');
        const confirmAvatar = document.getElementById('confirmAvatar');
        const addPointsModal = document.getElementById('addPointsModal');
        const cancelAddPoints = document.getElementById('cancelAddPoints');
        const addPointsModalText = document.getElementById('addPointsModalText');
        const removePointsModal = document.getElementById('removePointsModal');
        const cancelRemovePoints = document.getElementById('cancelRemovePoints');
        const removePointsModalText = document.getElementById('removePointsModalText');
        const studentIdInput = document.getElementById('studentId');
        const studentNameInput = document.getElementById('studentName');
        const addStudentBtn = document.getElementById('addStudentBtn');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Variables pour la gestion des avatars et points
        let selectedAvatar = null;
        let selectedStudentId = null;
        let pointsTargetStudents = [];
        
        // ==================== FONCTIONS FIREBASE ====================
        
        // Charger les élèves depuis Firebase
        function loadStudentsFromFirebase() {
            studentsRef.orderBy("id").onSnapshot((snapshot) => {
                students = [];
                snapshot.forEach((doc) => {
                    students.push(doc.data());
                });
                displayStudents();
                displayStudentList();
                updateSummary();
            }, (error) => {
                console.error("Erreur lors du chargement des élèves: ", error);
                alert("Erreur de connexion à la base de données. Les données affichées peuvent ne pas être à jour.");
            });
        }
        
        // Sauvegarder un élève dans Firebase
        async function saveStudentToFirebase(student) {
            try {
                await studentsRef.doc(student.id.toString()).set(student);
                console.log("Élève sauvegardé avec succès: ", student.id);
            } catch (error) {
                console.error("Erreur lors de la sauvegarde: ", error);
                alert("Erreur lors de la sauvegarde. Veuillez réessayer.");
            }
        }
        
        // Mettre à jour un élève dans Firebase
        async function updateStudentInFirebase(studentId, updates) {
            try {
                await studentsRef.doc(studentId.toString()).update(updates);
                console.log("Élève mis à jour avec succès: ", studentId);
            } catch (error) {
                console.error("Erreur lors de la mise à jour: ", error);
                alert("Erreur lors de la mise à jour. Veuillez réessayer.");
            }
        }
        
        // Supprimer un élève de Firebase
        async function deleteStudentFromFirebase(studentId) {
            try {
                await studentsRef.doc(studentId.toString()).delete();
                console.log("Élève supprimé avec succès: ", studentId);
            } catch (error) {
                console.error("Erreur lors de la suppression: ", error);
                alert("Erreur lors de la suppression. Veuillez réessayer.");
            }
        }
        
        // Initialiser les données par défaut (à exécuter une seule fois)
        async function initializeDefaultData() {
            const snapshot = await studentsRef.get();
            if (snapshot.empty) {
                // Ajouter les élèves par défaut seulement si la collection est vide
                const defaultStudents = [
                    { id: 1, name: "Léa", points: 12, avatar: "🐶", absent: false },
                    { id: 2, name: "Hugo", points: 8, avatar: "🐱", absent: false },
                    { id: 3, name: "Emma", points: 15, avatar: "🐭", absent: false },
                    { id: 4, name: "Lucas", points: 5, avatar: "🐹", absent: false },
                    { id: 5, name: "Chloé", points: 10, avatar: "🐰", absent: false },
                    { id: 6, name: "Thomas", points: 7, avatar: "🦊", absent: false },
                    { id: 7, name: "Zoé", points: 9, avatar: "🐻", absent: false },
                    { id: 8, name: "Nathan", points: 11, avatar: "🐼", absent: false },
                    { id: 9, name: "Manon", points: 6, avatar: "🐨", absent: false },
                    { id: 10, name: "Mathieu", points: 14, avatar: "🐯", absent: false },
                    { id: 11, name: "Inès", points: 8, avatar: "🦁", absent: false },
                    { id: 12, name: "Louis", points: 13, avatar: "🐮", absent: false },
                    { id: 13, name: "Julie", points: 4, avatar: "🐷", absent: false },
                    { id: 14, name: "Enzo", points: 10, avatar: "🐸", absent: false },
                    { id: 15, name: "Léa P.", points: 7, avatar: "🐙", absent: false },
                    { id: 16, name: "Raphaël", points: 9, avatar: "🐵", absent: false },
                    { id: 17, name: "Sarah", points: 11, avatar: "🦄", absent: false },
                    { id: 18, name: "Maxime", points: 6, avatar: "🐢", absent: false },
                    { id: 19, name: "Clara", points: 12, avatar: "🐬", absent: false },
                    { id: 20, name: "Alexandre", points: 8, avatar: "🐳", absent: false },
                    { id: 21, name: "Camille", points: 10, avatar: "🦖", absent: false },
                    { id: 22, name: "Quentin", points: 5, avatar: "🐠", absent: false },
                    { id: 23, name: "Lilou", points: 9, avatar: "🐌", absent: false },
                    { id: 24, name: "Noé", points: 13, avatar: "🦉", absent: false }
                ];
                
                const batch = db.batch();
                defaultStudents.forEach(student => {
                    const studentRef = studentsRef.doc(student.id.toString());
                    batch.set(studentRef, student);
                });
                
                await batch.commit();
                console.log("Données par défaut initialisées avec succès");
            }
        }
        
        // ==================== FONCTIONS DE L'APPLICATION ====================
        
        // Afficher les élèves dans la grille
        function displayStudents() {
            studentGrid.innerHTML = '';
            
            students.forEach(student => {
                const studentCard = document.createElement('div');
                studentCard.className = `student-card ${student.absent ? 'absent' : ''}`;
                studentCard.dataset.id = student.id;
                studentCard.dataset.absent = student.absent;
                
                studentCard.innerHTML = `
                    <input type="checkbox" class="student-checkbox" id="student-${student.id}">
                    ${student.absent ? '<div class="absent-badge">A</div>' : ''}
                    <div class="student-avatar">
                        <div class="avatar-img">${student.avatar}</div>
                    </div>
                    <div class="student-id">#${student.id}</div>
                    <div class="student-name">${student.name}</div>
                    <div class="points ${student.points >= 0 ? 'positive' : 'negative'}">${student.points}</div>
                `;
                
                studentGrid.appendChild(studentCard);
                
                // Ajouter l'écouteur d'événement pour la sélection
                const checkbox = studentCard.querySelector('.student-checkbox');
                checkbox.addEventListener('change', function() {
                    studentCard.classList.toggle('selected', this.checked);
                });
                
                // Ajouter l'écouteur pour la sélection (uniquement sur la carte, pas la checkbox)
                studentCard.addEventListener('click', function(e) {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        studentCard.classList.toggle('selected', checkbox.checked);
                    }
                });
            });
            
            updateSummary();
        }
        
        // Afficher la liste des élèves pour l'enseignant
        function displayStudentList() {
            studentList.innerHTML = '<h2>Liste des élèves</h2>';
            
            if (students.length === 0) {
                studentList.innerHTML += '<p>Aucun élève enregistré.</p>';
                return;
            }
            
            students.forEach(student => {
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';
                studentItem.innerHTML = `
                    <div>#${student.id} - ${student.name} ${student.absent ? '<span style="color:red">(Absent)</span>' : ''}</div>
                    <div>
                        <button class="remove-btn" data-id="${student.id}">Supprimer</button>
                    </div>
                `;
                
                studentList.appendChild(studentItem);
            });
            
            // Ajouter les écouteurs pour les boutons de suppression
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.dataset.id);
                    deleteStudent(id);
                });
            });
        }
        
        // Supprimer un élève
        async function deleteStudent(id) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer l'élève #${id} ?`)) {
                await deleteStudentFromFirebase(id);
            }
        }
        
        // Ajouter un nouvel élève
        async function addStudent() {
            const id = parseInt(studentIdInput.value);
            const name = studentNameInput.value.trim();
            
            if (!id || id < 1) {
                alert("Veuillez entrer un numéro de classe valide.");
                return;
            }
            
            if (!name) {
                alert("Veuillez entrer un prénom.");
                return;
            }
            
            // Vérifier si le numéro est déjà utilisé
            if (students.some(student => student.id === id)) {
                alert(`Le numéro #${id} est déjà utilisé.`);
                return;
            }
            
            // Choisir un avatar aléatoire
            const randomAvatar = avatars[Math.floor(Math.random() * avatars.length)];
            
            // Créer le nouvel élève
            const newStudent = {
                id: id,
                name: name,
                points: 0,
                avatar: randomAvatar,
                absent: false
            };
            
            // Sauvegarder dans Firebase
            await saveStudentToFirebase(newStudent);
            
            // Réinitialiser le formulaire
            studentIdInput.value = '';
            studentNameInput.value = '';
            
            alert(`Élève ${name} (#${id}) ajouté avec succès !`);
        }
        
        // Afficher les options d'avatar
        function displayAvatarOptions() {
            avatarGrid.innerHTML = '';
            
            avatars.forEach((avatar, index) => {
                const avatarOption = document.createElement('div');
                avatarOption.className = 'avatar-option';
                avatarOption.innerHTML = `<div class="avatar-option-emoji">${avatar}</div>`;
                avatarOption.dataset.avatar = avatar;
                
                avatarOption.addEventListener('click', function() {
                    // Désélectionner tous les avatars
                    document.querySelectorAll('.avatar-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Sélectionner cet avatar
                    this.classList.add('selected');
                    selectedAvatar = avatar;
                });
                
                avatarGrid.appendChild(avatarOption);
            });
        }
        
        // Mettre à jour le résumé des points
        function updateSummary() {
            let totalGreen = 0;
            let totalRed = 0;
            let totalAbsent = 0;
            
            students.forEach(student => {
                if (student.points >= 0) {
                    totalGreen += student.points;
                } else {
                    totalRed += Math.abs(student.points);
                }
                
                if (student.absent) {
                    totalAbsent += 1;
                }
            });
            
            totalGreenSpan.textContent = totalGreen;
            totalRedSpan.textContent = totalRed;
            totalAbsentSpan.textContent = totalAbsent;
        }
        
        // Ouvrir le popup pour AJOUTER des points
        function openAddPointsModal(studentIds) {
            // Filtrer les élèves absents
            const presentStudents = studentIds.filter(id => {
                const student = students.find(s => s.id === id);
                return student && !student.absent;
            });
            
            if (presentStudents.length === 0) {
                alert("Veuillez sélectionner au moins un élève présent.");
                return;
            }
            
            pointsTargetStudents = presentStudents;
            
            if (presentStudents.length === 1) {
                const student = students.find(s => s.id === presentStudents[0]);
                addPointsModalText.textContent = `Ajouter des points à ${student.name} (#${student.id})`;
            } else {
                addPointsModalText.textContent = `Ajouter des points à ${presentStudents.length} élèves sélectionnés`;
            }
            
            addPointsModal.style.display = 'flex';
        }
        
        // Ouvrir le popup pour RETIRER des points
        function openRemovePointsModal(studentIds) {
            // Filtrer les élèves absents
            const presentStudents = studentIds.filter(id => {
                const student = students.find(s => s.id === id);
                return student && !student.absent;
            });
            
            if (presentStudents.length === 0) {
                alert("Veuillez sélectionner au moins un élève présent.");
                return;
            }
            
            pointsTargetStudents = presentStudents;
            
            if (presentStudents.length === 1) {
                const student = students.find(s => s.id === presentStudents[0]);
                removePointsModalText.textContent = `Retirer des points à ${student.name} (#${student.id})`;
            } else {
                removePointsModalText.textContent = `Retirer des points à ${presentStudents.length} élèves sélectionnés`;
            }
            
            removePointsModal.style.display = 'flex';
        }
        
        // Appliquer des points aux élèves
        async function applyPoints(points) {
            const updates = [];
            
            for (const studentId of pointsTargetStudents) {
                const student = students.find(s => s.id === studentId);
                if (student) {
                    const newPoints = student.points + points;
                    updates.push(updateStudentInFirebase(studentId, { points: newPoints }));
                }
            }
            
            // Attendre que toutes les mises à jour soient terminées
            await Promise.all(updates);
            
            // Jouer le son correspondant
            if (points > 0) {
                playPositiveSound(); // Son pour points verts
            } else {
                playNegativeSound(); // Son pour points rouges
            }
            
            addPointsModal.style.display = 'none';
            removePointsModal.style.display = 'none';
        }
        
        // Marquer des élèves comme absents
        async function markStudentsAsAbsent() {
            const selectedStudents = getSelectedStudentIds();
            
            if (selectedStudents.length === 0) {
                alert("Veuillez sélectionner au moins un élève.");
                return;
            }
            
            const updates = [];
            for (const studentId of selectedStudents) {
                updates.push(updateStudentInFirebase(studentId, { absent: true }));
            }
            
            // Attendre que toutes les mises à jour soient terminées
            await Promise.all(updates);
            
            // Désélectionner tous les élèves
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.student-card').classList.remove('selected');
            });
            
            alert(`${selectedStudents.length} élève(s) marqué(s) comme absent(s).`);
        }
        
        // Marquer des élèves comme présents
        async function markStudentsAsPresent() {
            const selectedStudents = getSelectedStudentIds();
            
            if (selectedStudents.length === 0) {
                alert("Veuillez sélectionner au moins un élève.");
                return;
            }
            
            const updates = [];
            for (const studentId of selectedStudents) {
                updates.push(updateStudentInFirebase(studentId, { absent: false }));
            }
            
            // Attendre que toutes les mises à jour soient terminées
            await Promise.all(updates);
            
            // Désélectionner tous les élèves
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.student-card').classList.remove('selected');
            });
            
            alert(`${selectedStudents.length} élève(s) marqué(s) comme présent(s).`);
        }
        
        // Réinitialiser tous les points à zéro
        async function resetAllPoints() {
            const updates = [];
            
            for (const student of students) {
                updates.push(updateStudentInFirebase(student.id, { points: 0 }));
            }
            
            // Attendre que toutes les mises à jour soient terminées
            await Promise.all(updates);
            
            resetModal.style.display = 'none';
            alert("Tous les points ont été réinitialisés avec succès !");
        }
        
        // Obtenir les IDs des élèves sélectionnés
        function getSelectedStudentIds() {
            return Array.from(document.querySelectorAll('.student-checkbox:checked'))
                .map(checkbox => parseInt(checkbox.id.split('-')[1]));
        }
        
        // Sélectionner tous les élèves (présents et absents)
        function selectAllStudents() {
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.closest('.student-card').classList.add('selected');
            });
        }
        
        // Désélectionner tous les élèves
        function deselectAllStudents() {
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.student-card').classList.remove('selected');
            });
        }
        
        // Gestion des onglets
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                
                // Désactiver tous les onglets
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                // Activer l'onglet cliqué
                this.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // ==================== ÉVÉNEMENTS ====================
        
        selectAllBtn.addEventListener('click', selectAllStudents);
        
        deselectAllBtn.addEventListener('click', deselectAllStudents);
        
        resetBtn.addEventListener('click', function() {
            resetModal.style.display = 'flex';
        });
        
        cancelReset.addEventListener('click', function() {
            resetModal.style.display = 'none';
        });
        
        confirmReset.addEventListener('click', resetAllPoints);
        
        changeAvatarBtn.addEventListener('click', function() {
            const selectedStudents = getSelectedStudentIds();
            
            if (selectedStudents.length !== 1) {
                alert("Veuillez sélectionner un seul élève pour changer son avatar.");
                return;
            }
            
            const student = students.find(s => s.id === selectedStudents[0]);
            if (student && student.absent) {
                alert("Vous ne pouvez pas changer l'avatar d'un élève absent.");
                return;
            }
            
            selectedStudentId = selectedStudents[0];
            displayAvatarOptions();
            selectedAvatar = null;
            document.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            avatarModal.style.display = 'flex';
        });
        
        cancelAvatar.addEventListener('click', function() {
            avatarModal.style.display = 'none';
            selectedStudentId = null;
            selectedAvatar = null;
        });
        
        confirmAvatar.addEventListener('click', async function() {
            if (!selectedAvatar) {
                alert("Veuillez sélectionner un avatar.");
                return;
            }
            
            await updateStudentInFirebase(selectedStudentId, { avatar: selectedAvatar });
            avatarModal.style.display = 'none';
            
            const student = students.find(s => s.id === selectedStudentId);
            if (student) {
                alert(`Avatar de ${student.name} modifié avec succès !`);
            }
        });
        
        cancelAddPoints.addEventListener('click', function() {
            addPointsModal.style.display = 'none';
        });
        
        cancelRemovePoints.addEventListener('click', function() {
            removePointsModal.style.display = 'none';
        });
        
        // Événements pour les boutons de points (AJOUTER)
        document.querySelectorAll('#addPointsModal .point-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const points = parseInt(this.dataset.points);
                applyPoints(points);
            });
        });
        
        // Événements pour les boutons de points (RETIRER)
        document.querySelectorAll('#removePointsModal .point-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const points = parseInt(this.dataset.points);
                applyPoints(points);
            });
        });
        
        // Événement pour le bouton d'ajout d'élève
        addStudentBtn.addEventListener('click', addStudent);
        
        // Événement pour ajouter un élève avec la touche Entrée
        studentNameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addStudent();
            }
            // Empêcher le comportement par défaut de la touche Entrée
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });
        
        // Événements pour les boutons d'actions groupées
        addPointsBtn.addEventListener('click', function() {
            const selectedStudents = getSelectedStudentIds();
            openAddPointsModal(selectedStudents);
        });
        
        removePointsBtn.addEventListener('click', function() {
            const selectedStudents = getSelectedStudentIds();
            openRemovePointsModal(selectedStudents);
        });
        
        markAbsentBtn.addEventListener('click', markStudentsAsAbsent);
        
        markPresentBtn.addEventListener('click', markStudentsAsPresent);
        
        // ==================== INITIALISATION ====================
        
        // Initialiser l'application
        async function initializeApp() {
            try {
                // Charger les élèves depuis Firebase
                loadStudentsFromFirebase();
                
                // Initialiser les données par défaut (si nécessaire)
                await initializeDefaultData();
                
                console.log("Application initialisée avec succès");
            } catch (error) {
                console.error("Erreur lors de l'initialisation: ", error);
                alert("Erreur lors du chargement des données. Veuillez rafraîchir la page.");
            }
        }
        
        // Démarrer l'application
        initializeApp();
    </script>
</body>
</html>
